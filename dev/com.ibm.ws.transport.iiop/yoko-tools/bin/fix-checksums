#!/usr/bin/ruby2.0 -n

BEGIN {}

chomp()

case $_
when /^     \[echo\] ERROR! Checksum of ossc listed file ([^ ]*) has changed to (.*)\.$/
  file = $1 
  cksum = $2
when /^     \[echo\] \(Checked (.*)\)$/
  path = $1
  ossc = path.sub(%r{/[^/]+/[^/]+$},"/legal/ossc.xml")
  regex =  /basename="#{file}" checksum="[^"]+"/
  repl = "basename=\"#{file}\" checksum=\"#{cksum}\""
  File.open(ossc, "r+") do |f|
    old_pos = 0
    line_num = 0
    f.each do |line|
      f.pos = old_pos # rewind
      f.print line.sub(regex, repl) 
      old_pos = f.pos
    end
  end
end
  
END {}
