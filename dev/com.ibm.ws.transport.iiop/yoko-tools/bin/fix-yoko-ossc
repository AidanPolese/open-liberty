#!/bin/sh

(
    GitDir="${GitDir:-$HOME/work/idea/geronimo-yoko}"
    EclipseDir="${EclipseDir:-$HOME/work/eclipse/rtc}"

    [ -d "$GitDir" ] || { echo "### $GitDir NOT FOUND; aborting."; exit 1; } >&2
    [ -d "$EclipseDir" ] || { echo "### $EclipseDir NOT FOUND; aborting."; exit 1; } >&2

    Changeset="$(cd "$GitDir"; git log -1 HEAD |grep '^commit' |cut -d ' ' -f 2)"
    [ "$Changeset" ] || { echo "### Unable to extract HEAD changeset id from git; aborting."; exit 1; } >&2

    for Dir in $EclipseDir/*org.apache.yoko*; do
        Ossc="$Dir/legal/ossc.xml"
        [ -f "$Ossc" ] || { echo "### $Ossc NOT FOUND; skipping"; continue; }
        ( echo "### ${Dir##*/}"; cd "$Dir"; ant 2>/dev/null |fix-checksums; ant 2>&1 |grep '^BUILD'; )
        sed -i 's#\(<download location="[^"]*/\)[^"/]*"#\1'$Changeset'"#' "$Ossc"
    done
)
